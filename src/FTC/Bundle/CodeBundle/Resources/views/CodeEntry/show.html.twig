{% extends 'FTCWebBundle::layout.html.twig' %}

{% block content %}
<div class="row-fluid">
    <div class="span9">
        <div class="row">
            <div class="span9">
                <span class="label label-info">{{ entry.getTargetUserTypeText() }}</span>

                <h1 class="entry-title">
                    {{ entry.title }}
                    <!-- TODO: only if owner -->
                    <a href="{{ path('entry_edit', { 'id': entry.id }) }}" class="btn btn-mini"><i class="icon-pencil"></i></a>
                </h1>
            </div>
        </div>

        <div class="row">
            <div class="span9">
                <p>{{ entry.description|nl2br }}</p>
            </div>
        </div>

        <div class="row">
            <div class="span9 snippets">
                {% for snippet in entry.snippets %}
                    <div class="well editor-filename">
                        <div class="row-fluid">
                            <div class="span10">
                                <i class="icon-file"></i> {{ snippet.name }} (see latest | see top rated)
                            </div>
                            <div class="span2 right">
                                <a href="{{ path('entry_snippet_contribute', { id: entry.id, snippetId: snippet.id}) }}" class="btn btn-info btn-mini btn-edit-code" rel="editor{{ snippet.id }}" {% if not is_granted("IS_AUTHENTICATED_REMEMBERED") %}disabled="disabled"{% endif %}><i class="icon-pencil icon-white"></i>  edit this code</a>
                            </div>
                        </div>
                    </div>

                    <div id="editor{{ snippet.id }}" class="editor span9">{{ snippet.code }}</div>
                    <div id="editor{{ snippet.id }}-placeholder" class="editor-placeholder"></div>
                {% endfor %}
            </div>
        </div>

        <div class="row-fluid">
            <div class="span8">
                <h2>Reactions</h2>
            </div>
            <div class="span4 right">
                <a href="#" class="btn btn-info"><i class="icon-comment icon-white"></i> comment</a>
                <a href="#" class="btn btn-info"><i class="icon-pencil icon-white"></i> edit the code</a>
            </div>
        </div>
        <div class="row">
            <div class="span9">
                {% for comment in entry.comments %}
                    <div class="row-fluid comment">
                        <div class="span12">
                                <a href="#">
                                    <img src="{{ gravatar(comment.author.email, 20) }}" alt="{{comment.author.username}}">
                                    <strong>{{comment.author.fullname|default(comment.author.username)}}</strong>
                                </a>

                           {% if comment.snippet %}contributed to this code{% else %}commented on this code{% endif %}
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="well">

                                <div class="row-fluid">
                                    <div class="span12">
                                        {{ comment.comment }}
                                    </div>
                                </div>

                                <div class="row-fluid comment-code">
                                    <div class="span1"></div>
                                        {% if comment.snippet %}
                                        <div class="span10">
                                            <i class="icon-file"></i> {{ comment.snippet.name }}
                                        </div>
                                        <div id="editor{{ comment.snippet.id }}" class="editor span10">{{ comment.snippet.code }}</div>
                                        <div id="editor{{ comment.snippet.id }}-placeholder" class="editor-placeholder"></div>
                                        {% endif %}
                                    <div class="span1"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                {% else %}
                    <p>No reactions yet, be the first: <a href="#">comment</a> or <a href="#">tweak the code</a></p>
                {% endfor %}
            </div>
        </div>
        <div class="row">
            <div class="span9">
                <h4>Comment on this code:</h4>

                {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
                <form class="form-horizontal form-nolabels" action="{{ path("entry_comment_create", {id: entry.id}) }}" method="post" {{ form_enctype(comment_form) }}>
                    {{ form_widget(comment_form) }}
                    <div class="form-actions-nomargin">
                        <button type="submit" class="btn btn-primary"><i class="icon-comment icon-white"></i> comment</button>
                        <button type="reset" class="btn">Cancel</button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-block">
                  Please <a href="{{ path('login') }}">Login</a> or <a href="{{ path('fos_user_registration_register') }}">Register</a> to leave a comment.
                </div>
                {% endif %}


            </div>
        </div>
    </div>

    <div class="span3 sidebar">
        <div class="row-fluid profile">
            <div class="span8">
                <h3>{{ entry.author.fullName }}</h3>
                <p>Developer, gamer, lover of awesome code.</p>
            </div>
            <div class="span4">
                <img src="{{ gravatar(entry.author.email, 85) }}" alt="">
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12">
                <h3>Stats</h3>

                <dl class="stats">
                    <dt>12</dt>
                    <dd>Comments</dd>

                    <dt>12</dt>
                    <dd>Forks</dd>
                </dl>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12">
                <h3>Participants</h3>
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
                <img src="{{ gravatar(entry.author.email, 32) }}" alt="">
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block javascripts %}
{{parent()}}
<script src="/ace/ace-noconflict.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/theme-twilight-noconflict.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/mode-javascript-noconflict.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/mode-php-noconflict.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
<script src="/bundles/ftccode/js/code-editor.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" charset="utf-8">

    //Load Editor modes for languages in use
    {% for type in entry.getExtensionList() %}
        {% if type%}
            var {{type}}Mode = ace.require("ace/mode/{{type}}").Mode;
        {% endif %}
    {% endfor %}


    $(document).ready(function(){

        //Request editors
        {% for snippet in entry.snippets %}
            codeEditor.requestedEditors.push({id: "editor{{snippet.id}}", mode: new {{snippet.extension|default("php")}}Mode()});
        {% endfor %}

        //Load Editors
        codeEditor.loadPageEditors();

        //Enable Edit buttons
        $.template( "editCodeForm", $("#edit-code-form").html() );
        $('.btn-edit-code').on('click', codeEditor.wakeEditor);
    });

</script>

<script type="text/template" id="edit-code-form">
    <div id="${nodeId}" class="row code-comment-form-row">
        <div class="span9 code-comment-form">
            <form class="form-horizontal form-nolabels" action="${formAction}" method="post" {{ form_enctype(contrib_form) }}>
                {{ form_widget(contrib_form) }}
                <div class="form-actions-nomargin form-actions ">
                    <input type="submit" class="btn btn-primary" name="done" value="Submit changes" />
                    <button type="reset" class="btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</script>

{% endblock %}